#!/bin/bash

# Define the directory containing the chimeric and non-chimeric FASTA files
input_dir="/media/ali/data_store/test_chim/chimeras"
non_chimeric_dir="/media/ali/data_store/test_chim"

# Define the directory where the temporary file will be stored
temp_file_dir="/tmp/"
temp_file="$temp_file_dir/chimera_sequence.fasta"

# Define the directory where the report file will be saved
report_file="report.txt"

# Define the minimum occurrence of a sequence to be considered
min_occurrence=2

# Create the report file if it doesn't exist
touch "$report_file"

# Initialize the total chimera count variable
total_chimera_count=0

# Process each FASTA file in the input directory
for file in "$input_dir"/*.fasta; do
    # Get the file name without the extension
    basename=$(basename "$file" .fasta)

    # Get the corresponding non-chimeric file name
    non_chimeric_file="$non_chimeric_dir/$basename.fasta"

    # Initialize variables to store the current sequence and header
    sequence=""
    header=""
    # Read each line in the file
    while IFS= read -r line || [[ -n "$line" ]]; do
        # If the line starts with ">"", it's a header
        if [[ $line == ">"* ]]; then
            # If there's a previous sequence, save it and its header
            if [ -n "$sequence" ]; then
                # Extract the sequence and count its occurrences
                sequence_count=$(grep -c "$sequence" "$temp_file")

                # If the sequence occurs at least the minimum number of times, add it to the non-chimeric file
                if [ "$sequence_count" -ge "$min_occurrence" ]; then
                    echo -e "$header\n$sequence" >> "$non_chimeric_file"
                fi

                # Add the sequence to the temporary file
                echo "$sequence" >> "$temp_file"

                # Add the header and sequence count to the report file
                total_chimera_count=$((total_chimera_count + sequence_count))
            fi

            # Save the new header
            header=$line
            # Reset the sequence
            sequence=""
        else
            # If the line doesn't start with ">", it's part of a sequence
            sequence+="$line"
        fi
    done < "$file"

    # Save the last sequence in the file
    if [ -n "$sequence" ]; then
        # Extract the sequence and count its occurrences
        sequence_count=$(grep -c "$sequence" "$temp_file")

        # If the sequence occurs at least the minimum number of times, add it to the non-chimeric file
        if [ "$sequence_count" -ge "$min_occurrence" ]; then
            echo -e "$header\n$sequence" >> "$non_chimeric_file"
        fi

        # Add the sequence to the temporary file
        echo "$sequence" >> "$temp_file"

        # Add the header and sequence count to the report file
        total_chimera_count=$((total_chimera_count + sequence_count))
    fi
done

# Move the temporary file to the report file
mv "$temp_file" "$report_file"

# Print a completion message
echo "Processing complete. Chimeric sequences added to non-chimeric files."

# Generate a table summarizing the number of chimeras transferred from each file
cat "$report_file" | awk '{filename=$1; count=$2; print filename, count}' | sort -n > "informative_report.txt"
